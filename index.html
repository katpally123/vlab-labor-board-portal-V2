<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amazon VLAB | Virtual Labor Assignment Board</title>

  <!-- Tailwind for layout -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- App styles -->
  <link href="styles.css" rel="stylesheet">
</head>

<body class="bg-gray-50 text-gray-900 min-h-screen">
  <!-- Header: Dayshift IXD Staffing Board title band + OM / Shift Goal blocks -->
  <header class="board-header bg-white shadow px-2 py-3">
    <div class="board-header-row w-full flex items-center justify-between">
      <div class="header-left flex items-center gap-3">
        <div class="small-blocks flex flex-col text-sm show-board">
          <div class="am-pa">AM</div>
          <div class="am-pa">PA</div>
        </div>
      </div>
      <div class="board-title text-center flex-1">
        <div class="main-title">AMAZON VIRTUAL LABOR ASSIGNMENT BOARD</div>
      </div>
      <div class="header-blocks flex items-center gap-3">
        <div class="header-block show-board">
          <div class="hb-label">OM</div>
          <div class="hb-value" id="header-om">‚Äî</div>
        </div>
        <div class="header-block show-board">
          <div class="hb-label">SHIFT GOAL</div>
          <div class="hb-value" id="header-goal">‚Äî</div>
        </div>
        <div class="header-block site-selector">
          <div class="hb-label">üè≠ SITE</div>
      <select id="headerSiteSelector" class="hb-value bg-transparent border-none text-center font-bold cursor-pointer hover:bg-gray-50 rounded text-sm">
        <option value="YDD2">YDD2</option>
        <option value="YDD4">YDD4</option>
          </select>
        </div>
        <div class="header-actions flex items-center gap-2">
          <button class="border border-gray-300 rounded px-2 py-1 text-sm text-gray-700 show-analytics" id="exportLogBtn" title="Export analytics/logs">Export Log</button>
          <button id="lockAssignmentsBtn" class="border border-orange-600 text-orange-600 bg-white hover:bg-orange-50 rounded px-3 py-1 text-sm font-semibold show-board" title="Lock assignments and generate rotation report">üîí Lock & Report</button>
          <button id="publishBtn" class="border border-indigo-600 text-indigo-600 bg-white hover:bg-indigo-50 rounded px-3 py-1 text-sm font-semibold show-board">Publish</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Primary navigation (replaces burger) -->
  <nav class="primary-nav" role="tablist" aria-label="Primary navigation">
    <button class="nav-item active" data-target="roster" role="tab" aria-selected="true">üìã Roster</button>
    <button class="nav-item" data-target="siteBoard" role="tab" aria-selected="false">üß© Site Board</button>
    <button class="nav-item" data-target="analytics" role="tab" aria-selected="false">üìà Analytics</button>
    <button class="nav-item" data-target="manualScan" role="tab" aria-selected="false">üì± Manual Scan</button>
  </nav>
  <main class="w-full px-2 py-4">
    <!-- Legacy tab buttons removed; burger is the only navigation -->

    <!-- ROSTER TAB CONTENT -->
    <section id="tab-roster" class="tab-panel hidden" role="tabpanel" aria-labelledby="tabBtn-roster">
      <!-- Upload bar moved to top of Roster -->
      <form id="rosterForm" class="bg-white rounded shadow px-6 py-4 flex flex-wrap gap-6 items-end mb-4">
        <!-- File Uploads (Roster tab only) -->
        <div class="flex flex-col space-y-1">
          <label class="block font-semibold mb-1 text-sm">Uploads</label>
          <div id="fileZone" class="flex gap-1 flex-wrap">
            <label for="roster" class="pill-label">Roster File
              <input type="file" id="roster" name="roster" accept=".csv" class="hidden"
                    title="Upload CSV file with employee roster data">
              <span class="ml-2 file-label" id="label-roster"></span>
            </label>
            <label for="logins" class="pill-label" style="background:#e1f5fe; border-color:#0288d1;">Daily Logins (Optional)
              <input type="file" id="logins" name="logins" accept=".csv" class="hidden"
                    title="Upload CSV file with daily employee login data">
              <span class="ml-2 file-label" id="label-logins"></span>
            </label>
            <label for="adjustments" class="pill-label" style="background:#fef9c3; border-color:#ca8a04;">Adjustments (Optional)
              <input type="file" id="adjustments" name="adjustments" accept=".csv" class="hidden"
                    title="Upload CSV with SWAPIN/SWAPOUT/VET/VTO actions (User ID, Action, Date)">
              <span class="ml-2 file-label" id="label-adjustments"></span>
            </label>
          </div>
          <div class="text-xs text-gray-600 mt-1">
            <button type="button" id="downloadTemplateBtn" class="text-blue-600 hover:text-blue-800 underline"
                    title="Download CSV template for roster data">üìÑ Download Roster Template</button>
            <span class="mx-2">‚Ä¢</span>
            <button type="button" id="downloadAdjustmentTemplateBtn" class="text-yellow-600 hover:text-yellow-800 underline"
                    title="Download CSV template for adjustment actions">üìÑ Adjustment Template</button>
          </div>
        </div>
        <!-- Roster Database Management -->
        <div class="flex flex-col space-y-1">
          <label class="block font-semibold mb-1 text-sm">Database</label>
          <div class="flex gap-2 flex-wrap items-center">
            <button type="button" id="loadFromDatabaseBtn" class="border border-blue-300 text-blue-600 hover:bg-blue-50 rounded px-3 py-1 text-xs font-medium">üîÑ Load from Database</button>
            <button type="button" id="clearDatabaseBtn" class="border border-red-300 text-red-600 hover:bg-red-50 rounded px-3 py-1 text-xs">üóëÔ∏è Clear Database</button>
            <span id="databaseStatus" class="text-xs text-gray-500">Database: Not loaded</span>
          </div>
          <div class="text-xs text-gray-500 mt-1">
            Use "Load from Database" to work with existing 499 employees, or upload new roster to update database
          </div>
        </div>
        <button type="submit" class="bg-blue-600 text-white font-semibold rounded px-6 py-2">üìã Build Schedule Board</button>
        <!-- Assignment History Controls -->
        <div class="flex gap-1 ml-4">
          <button type="button" id="undoBtn" class="border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 hover:bg-gray-50" title="Undo last assignment (Ctrl+Z)">‚Ü∂ Undo</button>
          <button type="button" id="redoBtn" class="border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 hover:bg-gray-50" title="Redo assignment (Ctrl+Y)">‚Ü∑ Redo</button>
        </div>
      </form>
      <div class="bg-white rounded shadow px-6 py-4 mb-4">
        <!-- Roster-side schedule controls (Quarter remains in Site Board only) -->
  <div id="rosterScheduleControls" class="flex flex-wrap gap-6 items-start mb-4">
          <div>
            <label for="date_roster" class="block font-semibold mb-1 text-sm">Date</label>
            <input type="date" id="date_roster" class="border p-2 rounded w-40" title="Schedule date">
          </div>
          <div>
            <label class="block font-semibold mb-1 text-sm">Shift</label>
            <div class="flex items-center space-x-3">
              <label class="inline-flex items-center">
                <input type="radio" name="shift_roster" value="day" checked class="form-radio" id="shift-roster-day" title="Day shift">
                <span class="ml-1">Day</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="shift_roster" value="night" class="form-radio" id="shift-roster-night" title="Night shift">
                <span class="ml-1">Night</span>
              </label>
            </div>
          </div>
          <div>
            <label for="site_roster" class="block font-semibold mb-1 text-sm">Site</label>
            <select id="site_roster" class="border p-2 rounded w-28" title="Facility site">
              <option value="YHM2">YHM2</option>
              <option value="YDD2">YDD2</option>
              <option value="YDD4">YDD4</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="plannedVolumeRoster" class="block font-semibold mb-1 text-sm">Planned Volume</label>
            <div class="flex items-start gap-4">
              <input id="plannedVolumeRoster" placeholder="e.g., 52000" class="border rounded p-2 w-36" type="number" min="0" title="Planned volume">
              <!-- Smart Assignment controls removed per request -->
            </div>
          </div>
        </div>
        <div class="roster-filters mb-3">
          <div class="rf-title">Filters</div>
          <div id="rosterFiltersSummary" class="rf-chips"></div>
          <!-- Shift Code Filter Dropdown -->
          <div class="ml-auto flex items-center gap-2">
            <label for="rosterShiftCodeFilter" class="text-xs font-semibold text-gray-600">Shift Code:</label>
            <select id="rosterShiftCodeFilter" class="border rounded px-2 py-1 text-xs">
              <option value="">All</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
          <div class="bg-gray-50 rounded border p-3">
            <h3 class="text-sm font-bold mb-2">Shift Code Breakdown</h3>
            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-100 text-xs uppercase tracking-wider">
                  <tr>
                    <th class="px-3 py-2 text-left">Shift Code</th>
                    <th class="px-3 py-2 text-right">Count</th>
                  </tr>
                </thead>
                <tbody id="shiftCodeBody"></tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td class="px-3 py-2 font-semibold text-right">Total</td>
                    <td class="px-3 py-2 font-bold text-right" id="shiftCodeTotal">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="lg:col-span-2 bg-gray-50 rounded border p-3">
            <h3 class="text-sm font-bold mb-2">Roster Overview</h3>
            <!-- New: Adjustments & Logins summary chips shown beside overview -->
            <div id="rosterAdjSummary" class="flex flex-wrap gap-2 text-xs mb-2"></div>
            <div id="rosterOverviewContent" class="text-sm text-gray-800"></div>
          </div>
        </div>

        <!-- Included Associates moved below, replacing headcount table -->
        <div class="bg-white rounded border p-3">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-bold">Included Associates</h3>
            <div class="flex items-center gap-2">
              <input id="rosterIncludedSearch" type="text" class="border rounded px-2 py-1 text-sm" placeholder="Search name or ID..."/>
              <span id="rosterIncludedCount" class="text-xs text-gray-600">0</span>
            </div>
          </div>
          <div class="overflow-auto roster-included-list">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100 text-xs uppercase tracking-wider">
                <tr>
                  <th class="px-3 py-2 text-left">Name</th>
                  <th class="px-3 py-2 text-left">Employee ID</th>
                  <th class="px-3 py-2 text-left">Shift</th>
                  <th class="px-3 py-2 text-left">Dept</th>
                  <th class="px-3 py-2 text-left">Area</th>
                </tr>
              </thead>
              <tbody id="rosterIncludedList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  <!-- Site Board Scheduling Controls (moved date/shift/site/quarter/planned volume here) -->
  <div id="siteBoardControls" class="bg-white rounded shadow px-6 py-4 flex flex-wrap gap-6 items-end mb-4 hidden">
    <div>
      <label for="date" class="block font-semibold mb-1 text-sm">Date</label>
      <input type="date" id="date" name="date" class="border p-2 rounded w-40" required 
             title="Select the schedule date" placeholder="DD/MM/YYYY">
    </div>
    <div>
      <label class="block font-semibold mb-1 text-sm">Shift</label>
      <div class="flex items-center space-x-3">
        <label class="inline-flex items-center">
          <input type="radio" name="shift" value="day" checked class="form-radio" id="shift-day"
                 title="Select day shift">
          <span class="ml-1">Day</span>
        </label>
        <label class="inline-flex items-center">
          <input type="radio" name="shift" value="night" class="form-radio" id="shift-night"
                 title="Select night shift">
          <span class="ml-1">Night</span>
        </label>
      </div>
    </div>
    <div>
      <label for="site" class="block font-semibold mb-1 text-sm">Site</label>
  <select id="site" name="site" class="border p-2 rounded w-28" required
      title="Select the facility site (YDD2/YDD4 share associate pool)">
    <option value="YDD2">YDD2</option>
    <option value="YDD4">YDD4</option>
  </select>
    </div>
    <div>
      <label for="quarter" class="block font-semibold mb-1 text-sm">Quarter</label>
      <select id="quarter" name="quarter" class="border p-2 rounded w-28" required
              title="Select the quarter period">
        <option value="Q1">Q1</option>
        <option value="Q2">Q2</option>
        <option value="Q3">Q3</option>
        <option value="Q4">Q4</option>
      </select>
    </div>
    <div>
      <label for="plannedVolumeStub" class="block font-semibold mb-1 text-sm">Planned Volume</label>
      <input id="plannedVolumeStub" placeholder="e.g., 52000" class="border rounded p-2 w-36" 
             type="number" min="0" title="Enter planned volume for the shift">
    </div>
    <div class="flex flex-col">
      <label class="block font-semibold mb-1 text-sm invisible">Fetch</label>
      <button id="fetchRosterBtn" type="button" title="Fetch associates using Date/Shift/Site"
              class="border border-green-600 text-green-700 bg-white hover:bg-green-50 rounded px-4 py-2 text-sm font-semibold whitespace-nowrap">üîÑ Fetch Roster</button>
      <div class="flex gap-2 mt-2">
  <button id="clearBoardBtn" type="button" title="Move all assigned associates back to Unassigned for this site"
    class="border border-amber-600 text-amber-700 bg-white hover:bg-amber-50 rounded px-3 py-1 text-xs font-semibold whitespace-nowrap">üßπ Clear Board</button>
      </div>
    </div>
  </div>

  <!-- SITE BOARD TAB CONTENT (existing board wrapped) -->
  <section id="tab-siteBoard" class="tab-panel hidden" role="tabpanel" aria-labelledby="tabBtn-siteBoard">
  <!-- Summary row (7 columns) -->
    <div class="flex flex-wrap gap-3 mb-4">
      <div class="chip"><span class="font-medium">Date</span><span class="ml-2" id="displayDate">-</span></div>
      <div class="chip"><span class="font-medium">Day</span><span class="ml-2" id="displayDay">-</span></div>
      <div class="chip"><span class="font-medium">Shift</span><span class="ml-2" id="displayShift">-</span></div>
      <div class="chip"><span class="font-medium">Shift Type</span><span class="ml-2" id="displayShiftType">-</span></div>
      <div class="chip"><span class="font-medium">Site</span><span class="ml-2" id="displaySite">-</span></div>
      <div class="chip"><span class="font-medium">Planned HC</span><span class="ml-2" id="displayPlannedHC">0</span></div>
      <div class="chip"><span class="font-medium">Actual HC</span><span class="ml-2" id="displayActualHC">0</span></div>
    </div>

    <!-- Codes bar (compact) -->
    <div id="codesBar" class="hidden text-xs text-gray-600 mb-6"></div>

  <!-- Layout: left Unassigned sidebar + right board grid -->
    <div class="flex gap-4 mt-4">
      <aside id="leftPanel" class="w-64 bg-white border border-gray-200 rounded-xl p-3 h-[72vh] overflow-auto">
        <!-- Filter Controls -->
        <div id="filterControls" class="filter-controls">
          <div class="filter-row">
            <div class="filter-group" style="flex:1">
              <label class="filter-label">Search</label>
              <input type="text" id="nameFilter" class="filter-input" placeholder="Name or ID...">
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div id="bulkActions" class="bulk-actions">
          <div class="bulk-actions-controls">
            <span class="selected-count">0 selected</span>
            <button id="selectAllBtn" class="bulk-action-btn">Select All</button>
            <button id="clearSelectionBtn" class="bulk-action-btn">Clear</button>
            <select id="bulkAssignTarget" class="filter-input" style="min-width: 100px;">
              <option value="">Assign to...</option>
            </select>
            <button id="bulkAssignBtn" class="bulk-action-btn">Assign</button>
          </div>
        </div>

        <!-- Smart Assignment Tools relocated inline beside planned volume -->

        <div class="flex items-center justify-between mb-2">
            <h2 class="text-sm font-semibold">
              <span id="unassignedSiteLabel">Unassigned</span>
            </h2>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-600" id="unassignedCount">0</span>
              <button id="toggleUnassignedBtn" aria-expanded="false" aria-controls="unassignedStack" class="text-sm text-gray-500 border rounded p-1 hover:bg-gray-100">‚ñæ</button>
            </div>
          </div>
          <div id="unassignedStack" class="stack-column"></div>
      </aside>

      <div class="flex-1">
        <!-- Output / messages -->
        <div id="output" class="my-2 min-h-[60px]"></div>
        <!-- Board canvas (whiteboard) -->
  <div class="board-canvas bg-white border rounded-lg p-2 shadow-sm">
    <div class="process-grid">
      <div class="board-card"><div class="tile-header"><span class="font-semibold">CB</span><input id="tile-cb" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">IB WS</span><input id="tile-ibws" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Line Loaders</span><input id="tile-lineloaders" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Trickle</span><input id="tile-trickle" class="board-count-input" type="number" min="0"></div></div>

      <div class="board-card"><div class="tile-header"><span class="font-semibold">Destination Markers</span><input id="tile-dm" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">IDRT</span><input id="tile-idrt" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Pallet Build</span><input id="tile-pb" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Each to Sort</span><input id="tile-e2s" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Dock WS</span><input id="tile-dockws" class="board-count-input" type="number" min="0"></div></div>

      <div class="board-card"><div class="tile-header"><span class="font-semibold">E2S WS</span><input id="tile-e2sws" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Tote Pallet Build</span><input id="tile-tpb" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Tote WS</span><input id="tile-tws" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">SAP</span><input id="tile-sap" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">AO/5S</span><input id="tile-ao5s" class="board-count-input" type="number" min="0"></div></div>

      <!-- New process paths -->
      <div class="board-card"><div class="tile-header"><span class="font-semibold">PA (Process Assistant)</span><input id="tile-pa" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">PS (Problem Solvers)</span><input id="tile-ps" class="board-count-input" type="number" min="0"></div></div>
      <div class="board-card"><div class="tile-header"><span class="font-semibold">Labor Share</span><input id="tile-laborshare" class="board-count-input" type="number" min="0"></div></div>
    </div>
  </div>
      </div>
    </div>
    </section>

    <!-- MANUAL SCAN TAB CONTENT -->
    <section id="tab-manualScan" class="tab-panel hidden" role="tabpanel" aria-labelledby="tabBtn-manualScan">
      <div class="bg-white rounded shadow px-6 py-4 mb-4">
        <h2 class="text-xl font-bold mb-4">üì± Manual Scan Assignment Mode</h2>
        <p class="text-sm text-gray-600 mb-6">Scan process path barcodes followed by associate badges to record real-time floor assignments. This mode works even after the board is locked and feeds directly into rotation analytics.</p>
        
        <!-- Scan Session Context -->
        <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-6">
          <h3 class="text-sm font-bold mb-3">Scan Session Settings</h3>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label for="scan_date" class="block font-semibold mb-1 text-xs">Date</label>
              <input id="scan_date" type="date" class="border rounded px-2 py-1 text-sm w-full" required />
            </div>
            <div>
              <label for="scan_shift" class="block font-semibold mb-1 text-xs">Shift</label>
              <select id="scan_shift" class="border rounded px-2 py-1 text-sm w-full" required>
                <option value="day">Day</option>
                <option value="night">Night</option>
              </select>
            </div>
            <div>
              <label for="scan_site" class="block font-semibold mb-1 text-xs">Site</label>
              <select id="scan_site" class="border rounded px-2 py-1 text-sm w-full" required>
                <option value="YDD2">YDD2</option>
                <option value="YDD4">YDD4</option>
                <option value="YHM2">YHM2</option>
              </select>
            </div>
            <div>
              <label for="scan_shift_code" class="block font-semibold mb-1 text-xs">Shift Code</label>
              <select id="scan_shift_code" class="border rounded px-2 py-1 text-sm w-full" required>
                <option value="DA">DA</option>
                <option value="DB">DB</option>
                <option value="DC">DC</option>
                <option value="DL">DL</option>
                <option value="DN">DN</option>
                <option value="DH">DH</option>
                <option value="NA">NA</option>
                <option value="NB">NB</option>
                <option value="NC">NC</option>
                <option value="NL">NL</option>
                <option value="NN">NN</option>
                <option value="NH">NH</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Scanner Interface -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Left: Scanner Inputs -->
          <div>
            <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
              <h3 class="text-sm font-bold mb-4">Scanner Input</h3>
              
              <!-- Path Scanner -->
              <div class="mb-4">
                <label for="scan_path_input" class="block font-semibold mb-2 text-sm">1Ô∏è‚É£ Scan Process Path Barcode</label>
                <input 
                  id="scan_path_input" 
                  type="text" 
                  class="border-2 border-green-400 rounded px-3 py-2 text-lg w-full font-mono" 
                  placeholder="Scan path barcode..." 
                  autocomplete="off"
                />
                <p class="text-xs text-gray-500 mt-1">Scan or type path code (CB, DM, PB, SORT, etc.)</p>
              </div>

              <!-- Current Path Display -->
              <div id="scan_current_path_display" class="bg-green-50 border border-green-300 rounded p-3 mb-4 hidden">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-xs text-gray-600">Current Path:</p>
                    <p id="scan_current_path_name" class="text-xl font-bold text-green-700">CB</p>
                  </div>
                  <button id="scan_clear_path" class="text-xs text-red-600 hover:underline">Clear Path</button>
                </div>
              </div>

              <!-- Associate Scanner -->
              <div class="mb-4">
                <label for="scan_associate_input" class="block font-semibold mb-2 text-sm">2Ô∏è‚É£ Scan Associate Badge</label>
                <input 
                  id="scan_associate_input" 
                  type="text" 
                  class="border-2 border-blue-400 rounded px-3 py-2 text-lg w-full font-mono" 
                  placeholder="Scan badge..." 
                  autocomplete="off"
                  disabled
                />
                <p class="text-xs text-gray-500 mt-1">Scan or type badge ID / Employee ID</p>
              </div>

              <!-- Last Scan Status -->
              <div id="scan_status_display" class="hidden">
                <div id="scan_status_content" class="rounded p-3 text-sm"></div>
              </div>
            </div>
          </div>

          <!-- Right: Recent Scans -->
          <div>
            <div class="bg-white border border-gray-300 rounded-lg p-4">
              <h3 class="text-sm font-bold mb-3">Recent Scans</h3>
              <div id="scan_recent_list" class="space-y-2 max-h-96 overflow-y-auto">
                <p class="text-sm text-gray-400 italic">No scans yet...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Path Barcode Reference Guide -->
        <div class="bg-gray-50 border border-gray-300 rounded-lg p-4">
          <h3 class="text-sm font-bold mb-3">üìã Process Path Barcode Reference</h3>
          <p class="text-xs text-gray-600 mb-3">Print these barcodes and place them at each process station. Managers scan the path barcode to set the active assignment location.</p>
          
          <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">CB</div>
              <div class="text-xs text-gray-600">Case Breakdown</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">DM</div>
              <div class="text-xs text-gray-600">Decant Mez</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">PB</div>
              <div class="text-xs text-gray-600">Pick Buffer</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">E2S</div>
              <div class="text-xs text-gray-600">Each to Sorter</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">DOCKWS</div>
              <div class="text-xs text-gray-600">Dock Waterspider</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">IBWS</div>
              <div class="text-xs text-gray-600">Inbound WS</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">OBWS</div>
              <div class="text-xs text-gray-600">Outbound WS</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">SORT</div>
              <div class="text-xs text-gray-600">Sort</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">PACK</div>
              <div class="text-xs text-gray-600">Pack</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">CRETS</div>
              <div class="text-xs text-gray-600">CRETs Process</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">PA</div>
              <div class="text-xs text-gray-600">Process Assistant</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">PS</div>
              <div class="text-xs text-gray-600">Problem Solver</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">LABORSHARE</div>
              <div class="text-xs text-gray-600">Labor Share</div>
            </div>
            <div class="bg-white border rounded p-2 text-center">
              <div class="font-mono text-lg font-bold">AO5S</div>
              <div class="text-xs text-gray-600">AO/5S</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ANALYTICS TAB CONTENT -->
    <section id="tab-analytics" class="tab-panel hidden" role="tabpanel" aria-labelledby="tabBtn-analytics">
      <div id="analyticsEmbedTarget" class="bg-white rounded shadow px-4 py-3">
        <!-- Internal analytics navigation + search + export -->
        <div class="analytics-tabs" role="tablist" aria-label="Analytics sections">
          <button class="analytics-tab active" data-tab="overview" role="tab" aria-selected="true">Overview</button>
          <button class="analytics-tab" data-tab="performance" role="tab" aria-selected="false">Performance</button>
          <button class="analytics-tab" data-tab="assignments" role="tab" aria-selected="false">Assignments</button>
          <button class="analytics-tab" data-tab="rotation" role="tab" aria-selected="false">Rotation</button>
          <div style="flex:1"></div>
          <input id="analyticsSearchInput" class="analytics-search-input" type="text" placeholder="Search associate..." aria-label="Search analytics" style="max-width:220px; margin:8px"/>
          <button id="exportAnalyticsBtn" class="border border-gray-300 rounded px-2 py-1 text-xs text-gray-700 bg-white hover:bg-gray-50" title="Export analytics CSV">Export CSV</button>
        </div>
        <div id="analyticsSearchResults" class="analytics-search-results hidden" aria-live="polite"></div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="analytics-tab-content">
          <div class="analytics-grid">
            <div class="analytics-card">
              <h3>Session Summary</h3>
              <div id="sessionSummary" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>Assignment Activity</h3>
              <div id="assignmentActivity" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>Process Distribution</h3>
              <div id="processDistribution" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>Efficiency Metrics</h3>
              <div id="efficiencyMetrics" class="analytics-content"></div>
            </div>
          </div>
        </div>

        <!-- Performance Tab -->
        <div id="tab-performance" class="analytics-tab-content hidden">
          <!-- Filters row -->
          <div class="flex flex-wrap items-center gap-3 mb-3">
            <div class="text-sm font-medium">Filters:</div>
            <div class="flex items-center gap-1">
              <label for="performanceShiftFilter" class="text-xs text-gray-600">Shift</label>
              <select id="performanceShiftFilter" class="border rounded px-2 py-1 text-sm">
                <option value="auto">Auto</option>
                <option value="day">Day</option>
                <option value="night">Night</option>
              </select>
            </div>
            <div class="flex items-center gap-1">
              <label for="performanceProcessFilter" class="text-xs text-gray-600">Process</label>
              <select id="performanceProcessFilter" class="border rounded px-2 py-1 text-sm">
                <option value="all">All</option>
                <option value="PICK">Pick</option>
                <option value="SORT">Sort</option>
                <option value="DOCK">Dock</option>
              </select>
            </div>
            <div class="flex items-center gap-1">
              <label for="performanceDateFilter" class="text-xs text-gray-600">Date</label>
              <input id="performanceDateFilter" type="date" class="border rounded px-2 py-1 text-sm" />
            </div>
          </div>
          <div class="analytics-grid">
            <div class="analytics-card">
              <h3>Planned vs Actual Headcount</h3>
              <div id="perfPlannedActual" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>Attendance Rate</h3>
              <div id="perfAttendance" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>VET / VTO Participation</h3>
              <div id="perfVetVto" class="analytics-content"></div>
            </div>
            <div class="analytics-card full-width">
              <h3>Process-level Performance</h3>
              <div id="perfProcessPerformance" class="analytics-content"></div>
            </div>
          </div>
        </div>

        <!-- Assignments Tab -->
        <div id="tab-assignments" class="analytics-tab-content hidden">
          <div class="flex items-center gap-3 mb-3">
            <label for="quarterFilter" class="text-sm font-medium">Quarter:</label>
            <select id="quarterFilter" class="border rounded px-2 py-1 text-sm">
              <option value="all">All</option>
              <option value="Q1">Q1</option>
              <option value="Q2">Q2</option>
              <option value="Q3">Q3</option>
            </select>
            <div class="ml-auto flex items-center gap-2">
              <input id="assignmentsSearch" type="text" placeholder="Filter assignment log..." class="border rounded px-2 py-1 text-sm" style="min-width:220px"/>
            </div>
          </div>
          <div class="analytics-grid">
            <div class="analytics-card full-width">
              <h3>Assignment Log</h3>
              <div class="overflow-auto">
                <table class="min-w-full text-sm" id="assignmentsTable">
                  <thead class="bg-gray-100 text-xs uppercase tracking-wider">
                    <tr>
                      <th class="px-3 py-2 text-left">Associate ID</th>
                      <th class="px-3 py-2 text-left">Associate Name</th>
                      <th class="px-3 py-2 text-left">Process Path</th>
                      <th class="px-3 py-2 text-left">Action</th>
                      <th class="px-3 py-2 text-left">Timestamp</th>
                      <th class="px-3 py-2 text-left">Quarter</th>
                    </tr>
                  </thead>
                  <tbody id="assignmentsTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="analytics-card">
              <h3>Patterns</h3>
              <div id="assignmentPatterns" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>Recommendations</h3>
              <div id="assignmentRecommendations" class="analytics-content"></div>
            </div>
          </div>
        </div>

        <!-- Rotation Tab -->
        <div id="tab-rotation" class="analytics-tab-content hidden">
          <div class="flex items-center gap-3 mb-3">
            <label for="rotationQuarterToggle" class="text-sm font-medium">Quarter:</label>
            <select id="rotationQuarterToggle" class="border rounded px-2 py-1 text-sm">
              <option value="Q1">Q1</option>
              <option value="Q2">Q2</option>
              <option value="Q3">Q3</option>
            </select>
          </div>
          <div class="analytics-grid">
            <div class="analytics-card full-width">
              <h3>Rotation Summary</h3>
              <div id="rotationSummary" class="analytics-content"></div>
            </div>
            <div class="analytics-card">
              <h3>Fairness Index</h3>
              <div id="rotationFairnessIndex" class="analytics-content"></div>
            </div>
          </div>
        </div>
        
      </div>
    </section>
  </main>

  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- App logic -->
  <script src="app.js"></script>
  <script>
    // File input label handlers
    (function(){
      const fileInputs = ['roster', 'logins', 'adjustments'];
      fileInputs.forEach(name => {
        const input = document.getElementById(name);
        const label = document.getElementById('label-' + name);
        if (input && label) {
          input.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
              label.textContent = files[0].name;
              label.style.color = '#059669';
            } else {
              label.textContent = '';
            }
          });
        }
      });
    })();
    
    // Primary nav controller (no burger)
    (function(){
      const panels = document.querySelectorAll('.tab-panel');
      const navItems = document.querySelectorAll('.primary-nav .nav-item');
  const rosterForm = document.getElementById('rosterForm');
  const siteBoardControls = document.getElementById('siteBoardControls');
      const body = document.body;
      function activate(target){
        panels.forEach(p=>{ const on = p.id === 'tab-' + target; p.classList.toggle('hidden', !on); });
  if (rosterForm){ rosterForm.classList.toggle('hidden', target !== 'roster'); }
  if (siteBoardControls){ siteBoardControls.classList.toggle('hidden', target !== 'siteBoard'); }
        body.classList.remove('mode-roster','mode-siteBoard','mode-analytics','mode-manualScan');
        body.classList.add(target === 'roster' ? 'mode-roster' : target === 'siteBoard' ? 'mode-siteBoard' : target === 'manualScan' ? 'mode-manualScan' : 'mode-analytics');
        navItems.forEach(it => {
          const active = it.dataset.target === target;
          it.classList.toggle('active', active);
          it.setAttribute('aria-selected', String(active));
        });
        try{ if (typeof renderHeadcountOverview === 'function') renderHeadcountOverview(); }catch(_){ }
  // When switching to Analytics, ensure initial content is loaded
        if (target === 'analytics') {
          try {
            if (typeof loadAnalyticsContent === 'function') {
              loadAnalyticsContent('overview');
            }
            // Setup quarter filter after content renders
            if (typeof setupQuarterFilter === 'function') {
              setTimeout(() => setupQuarterFilter(), 50);
            }
          } catch (e) { console.warn('Analytics activation error:', e); }
        }
        // When switching to Manual Scan, setup path card handlers
        if (target === 'manualScan') {
          try {
            if (window.MANUAL_SCAN && typeof window.MANUAL_SCAN.setupPathCardClickHandlers === 'function') {
              setTimeout(() => window.MANUAL_SCAN.setupPathCardClickHandlers(), 50);
            }
          } catch (e) { console.warn('Manual Scan activation error:', e); }
        }
        // When switching to Site Board, refresh counts/status
        if (target === 'siteBoard') {
          try { if (typeof setCounts === 'function') setCounts(); } catch(_){ }
        }
      }
      navItems.forEach(it => it.addEventListener('click', ()=> { 
        const target = it.dataset.target; 
        try { localStorage.setItem('vlab:lastTab', target); } catch(_) {}
        activate(target);
      }));
      // Restore last active tab from localStorage, default to roster for easier testing
      try {
        const lastTab = localStorage.getItem('vlab:lastTab');
        const startTab = lastTab && ['roster','siteBoard','analytics','manualScan'].includes(lastTab) ? lastTab : 'roster';
        console.log('[DEBUG] Starting with tab:', startTab);
        activate(startTab);
      } catch(_) { 
        console.log('[DEBUG] Starting with default roster tab');
        activate('roster'); 
      }
      // Save whenever we programmatically activate too
      window.__activatePrimaryTab = function(target){
        try { localStorage.setItem('vlab:lastTab', target); } catch(_) {}
        activate(target);
      };
    })();
  </script>

  <script>
    // Sync roster-side controls to the main Site Board controls (single source of truth)
    (function(){
      const get = id => document.getElementById(id);
      // Determine today's date in Canada (Eastern Time) and set defaults if empty
      try {
        const tz = 'America/Toronto';
        const now = new Date();
        // Convert to target timezone via toLocaleString then rebuild date
        const parts = new Date(now.toLocaleString('en-CA', { timeZone: tz }));
        const yyyy = parts.getFullYear();
        const mm = String(parts.getMonth()+1).padStart(2,'0');
        const dd = String(parts.getDate()).padStart(2,'0');
        const isoDate = `${yyyy}-${mm}-${dd}`;
        const dateMain = get('date');
        const dateRoster = get('date_roster');
        if (dateMain && !dateMain.value) dateMain.value = isoDate;
        if (dateRoster && !dateRoster.value) dateRoster.value = isoDate;
      } catch(e){ console.warn('[DATE INIT] Failed to set default date', e); }
      function syncRosterToSite(triggerRender=true){
        const siteR = get('site_roster');
        const site = get('site');
        if (siteR && site) site.value = siteR.value;

        const dateR = get('date_roster');
        const date = get('date');
        if (dateR && date) date.value = dateR.value;

        const pvR = get('plannedVolumeRoster');
        const pv = get('plannedVolumeStub');
        if (pvR && pv) pv.value = pvR.value;

        const shiftR = document.querySelector('input[name="shift_roster"]:checked');
        const day = get('shift-day');
        const night = get('shift-night');
        if (shiftR && day && night){
          if (shiftR.value === 'day') day.checked = true; else night.checked = true;
        }

        // Update unassigned header and dependent panels
        try{ if (typeof renderHeadcountOverview === 'function' && triggerRender) renderHeadcountOverview(); }catch(_){ }
        try{ if (typeof setCounts === 'function' && triggerRender) setCounts(); }catch(_){ }
      }

      function copySiteToRoster(){
        const siteR = get('site_roster'); const site = get('site'); if (site && siteR) siteR.value = site.value;
        const dateR = get('date_roster'); const date = get('date'); if (date && dateR) dateR.value = date.value;
        const pvR = get('plannedVolumeRoster'); const pv = get('plannedVolumeStub'); if (pv && pvR) pvR.value = pv.value;
        const dayR = get('shift-roster-day'); const nightR = get('shift-roster-night');
        const selected = document.querySelector('input[name="shift"]:checked');
        if (dayR && nightR && selected){ (selected.value === 'day' ? dayR : nightR).checked = true; }
      }

      // === Scheduling Controls Persistence ===
      function loadSchedule(){
        try {
          const raw = localStorage.getItem('vlab:schedule');
          if (!raw) return;
          const s = JSON.parse(raw);
          if (s.date && get('date')) get('date').value = s.date;
          // Coerce YHM2 to YDD2 for Site Board (YHM2 has its own board)
          if (s.site === 'YHM2') s.site = 'YDD2';
          if (s.shift){
            const radio = document.querySelector(`input[name="shift"][value="${s.shift}"]`);
            if (radio) radio.checked = true;
          }
          if (s.site && get('site')) get('site').value = s.site;
          if (s.quarter && get('quarter')) get('quarter').value = s.quarter;
          if (typeof s.plannedVolume !== 'undefined' && get('plannedVolumeStub')) get('plannedVolumeStub').value = s.plannedVolume;
        } catch(e){ console.warn('[SCHEDULE] Failed to load schedule', e); }
      }
      function saveSchedule(){
        try {
          const payload = {
            date: get('date')?.value || '',
            shift: document.querySelector('input[name="shift"]:checked')?.value || 'day',
            site: get('site')?.value || '',
            quarter: get('quarter')?.value || '',
            plannedVolume: get('plannedVolumeStub')?.value || ''
          };
          localStorage.setItem('vlab:schedule', JSON.stringify(payload));
        } catch(e){ console.warn('[SCHEDULE] Failed to save schedule', e); }
      }
      // Load saved schedule before copying to roster controls
      loadSchedule();
      // Save on any change
      ['date','site','quarter','plannedVolumeStub'].forEach(id => { const el = get(id); if (el) el.addEventListener('change', saveSchedule); });
      document.querySelectorAll('input[name="shift"]').forEach(el => el.addEventListener('change', saveSchedule));

      // Expose manual save for debug
      window.__saveSchedule = saveSchedule;

      // Hook up listeners on roster controls
      ['site_roster','date_roster','plannedVolumeRoster'].forEach(id => {
        const el = get(id); if (el) el.addEventListener('change', () => syncRosterToSite(true));
      });
      document.querySelectorAll('input[name="shift_roster"]').forEach(el => el.addEventListener('change', () => syncRosterToSite(true)));

      // Keep roster controls in sync when switching tabs
      const originalActivate = window.__activatePrimaryTab;
      window.__activatePrimaryTab = function(target){
        originalActivate && originalActivate(target);
        if (target === 'roster') { copySiteToRoster(); try{ renderHeadcountOverview(); }catch(_){} }
      };

      // Initialize roster controls from current site controls on first load
      copySiteToRoster();
      // Trigger initial renders after default date injection
      try{ if (typeof renderHeadcountOverview === 'function') renderHeadcountOverview(); }catch(_){ }
      try{ if (typeof setCounts === 'function') setCounts(); }catch(_){ }
    })();
  </script>

  <script>
    // Show file names
    ['roster','missing','logins','adjustments'].forEach(function(id) {
      const input = document.getElementById(id);
      const label = document.getElementById('label-'+id);
      if (!input) return;
      input.addEventListener('change', () => {
        const name = (input.files && input.files[0]) ? input.files[0].name : '';
        console.debug('[file-change]', id, 'files=', input.files, 'name=', name);
        if (label) label.textContent = name;
        // Keep a reference in case the input is later cleared by other DOM operations
        window.__LAST_UPLOADS = window.__LAST_UPLOADS || {};
        window.__LAST_UPLOADS[id] = (input.files && input.files[0]) ? input.files[0] : null;
      });
    });

    // Download Upload Template - Same format as roster with 2 examples
    document.getElementById('downloadTemplateBtn')?.addEventListener('click', () => {
      const templateData = `Employee ID	User ID	Employee Name	Badge Barcode ID	Department ID	Employment Start Date	Employment Type	Employee Status	Manager Name	Management Area ID	Shift Pattern
110888249	qruchikr	Ruchika,Ruchika	13966332	1299020	Wed Sep 22 00:00:00 UTC 2021	AMZN	Active	Bhatt,Devashish	3	DA6C0700
204374752	ipanidhi	Patel,Nidhi	11300296	1211070	Tue Jun 10 00:00:00 UTC 2025	TEMP	Active	Gray,Torii	22	NL6C1930`;
      
      const blob = new Blob([templateData], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'upload-template.csv';
      a.click();
      URL.revokeObjectURL(a.href);
      console.log('[DOWNLOAD] Downloaded upload template');
    });
  </script>
  <!-- (Removed legacy analytics modal; now embedded in Analytics tab) -->

  <!-- Exit Publish button (placed outside header so it's visible in published mode) -->
  <button id="exitPublishBtn" class="border border-red-600 text-red-600 bg-white hover:bg-red-50 rounded px-3 py-1 text-sm font-semibold hidden">Exit Publish</button>

  <!-- Toast Notification Container -->
  <div id="toastContainer" class="toast-container"></div>

</body>
</html>
